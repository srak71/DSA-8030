---
title: "Opioid Prescription Trends"
author: "Saransh Rakshak"
output: html_document
date: "Due: October 21, 2024"
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(summarytools)
```

```{R}
scripts <- read.csv("data/op_2021_data.csv")
scripts <- scripts %>%
  rename(last_name = NPPES.Provider.Last.Name,
         first_name = NPPES.Provider.First.Name,
         zip_code = NPPES.Provider.ZIP.Code,
         state = NPPES.Provider.State,
         doc_spec = Specialty.Description,
         tot_presc_cnt = Total.Claim.Count,
         op_cnt =  Opioid.Claim.Count,
         op_rate = Opioid.Prescribing.Rate,
         LA_op_cnt = Long.Acting.Opioid.Claim.Count,
         LA_op_rate = Long.Acting.Opioid.Prescribing.Rate)

# Selecting relevant columns
scripts <- scripts %>%
  select(zip_code, state, doc_spec, op_cnt, op_rate, LA_op_cnt, LA_op_rate)

# Removing doctors who have not prescribed any opioids
scripts <- scripts %>%
  filter(op_cnt > 0)

# Replacing NA values in LA_op_cnt and LA_op_rate with 0
scripts$LA_op_cnt[is.na(scripts$LA_op_cnt)] <- 0
scripts$LA_op_rate[is.na(scripts$LA_op_rate)] <- 0

# Turning double LA_op_cnt to int
scripts$LA_op_cnt <- as.integer(scripts$LA_op_cnt)

glimpse(scripts)
summary(scripts)
```

The scripts dataset contains the following values:

    - NPI:  National Provider Identifier for Doctor Identification.
    - last_name, first_name: Prescribing Doctor's last and first name.
    - zip_code: Zip code of prescriber.
    - state: State of prescriber.
    - doc_spec: Specialty of Doctor (ex. Anesthesiology, Internal Medicine, Dentist, etc.)
    - tot_presc_cnt: Total amount of prescriptions by the doctor (inclusive of non-opioids)
    - op_cnt: Amount of opioid prescriptions by the doctor.
    - op_rate: Changes in the amount of opioid prescriptions over time by the doctor.
    - LA_op_cnt: Amount of Long-Acting opioid prescriptions by the doctor.
    - LA_op_rate: Changes in the amount of Long-Acting opioid prescriptions over time by the doctor.



```{R}
income <- read.csv("data/IRSIncomeByZipCode.csv")
income <- income %>% 
  rename(state = STATE,
         zip_code = ZIPCODE,
         num_tax_ret = `Number.of.returns`,
         zip_agi = `Adjusted.gross.income..AGI.`,
         zip_avg_agi = `Avg.AGI`,
         ret_w_total = `Number.of.returns.with.total.income`,
         sum_zip_income = `Total.income.amount`,
         zip_avg_income = `Avg.total.income`,
         num_ret_taxable = `Number.of.returns.with.taxable.income`,
         taxable_amt = `Taxable.income.amount`,
         avg_taxable = `Avg.taxable.income`)

# Selecting relevant columns
income <- income %>%
  select(state, zip_code, zip_avg_income)

income$zip_avg_income <- income$zip_avg_income * 1000

# Removing rows where zip_code does not have 5 digits or 99999 zip codes
income <- income %>%
  filter(nchar(as.character(zip_code)) == 5) %>%
  filter(zip_code != 99999)

glimpse(income)
summary(income)
```
  
The income dataset contains the following values:

    - state: The state the zip code is located in.
    - zipcode: Zipcode.
    - AGI: Adjusted Gross Income
    

## Merging the two dataframes.

```{R}
# Merging by zip_code and state
merged <- scripts %>%
  left_join(income, by = c("state", "zip_code")) %>%
  na.omit(merged)

head(merged)
```


We will begin the analysis by looking at opioid prescription types. The two types of opioid prescriptions are regular acting (op_cnt, op_rate) and Long Acting (LA_op_cnt, LA_op_rate). From Figure 1, we can see that regular acting opioids are prescribed far more often than Long Acting. 


```{R}

total_prescribed <- merged %>%
  summarise(total_op_cnt = sum(op_cnt, na.rm = TRUE),
            total_LA_cnt = sum(LA_op_cnt, na.rm = TRUE))

total_prescribed

```


